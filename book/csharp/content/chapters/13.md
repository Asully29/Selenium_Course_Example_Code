# Running Browsers In The Cloud

If you've ever needed to test features in an older browser like Internet Explorer 8 or 9 then odds are you ran a virtual machine (VM) on your computer with a "legit" version of Windows.

Handy, but what happens when you need to check things on multiple versions of IE? Now you're looking at multiple VMs. And what about when you need cover other browser and Operating System (OS) combinations? Now you're looking at provisioning, running, and maintaining your own set of machines and standing up something like Selenium Grid to coordinate tests across them.

Rather than take on the overhead of a test infrastructure you can easily outsource this to a third-party cloud provider like [Sauce Labs](https://saucelabs.com/).

## A Selenium Remote, Selenium Grid, And Sauce Labs Primer

At the heart of Selenium at scale is the use of Selenium Grid and Selenium Remote.

Selenium Grid lets you distribute test execution across several machines and you connect to it with Selenium Remote. You tell the Grid which browser and OS you want your test to run on through the use of Selenium Remote's `Capabilities`.

Under the hood this is how Sauce Labs works. They are ultimately running Selenium Grid behind the scenes, and they receive and execute tests through Selenium Remote and the `Capabilities` you set.

Let's dig in with an example.

## An Example

### Part 1: Initial Setup

__NOTE: You'll need an account to use Sauce Labs. Their [free trial](https://saucelabs.com/signup/trial) offers enough to get you started. And if you're signing up because you want to test an open source project, then be sure to check out their [Open Sauce account](https://saucelabs.com/open-source).__

With Sauce Labs we need to provide specifics about what we want in our test environment, our credentials, and configure Selenium a little bit differently. Let's start by updating our `BaseTest.cs` file to include the details we'll need to specify.

In addition to the `BaseUrl` and `BrowserName` key/values, we'll add some more (e.g., `Host`, `BrowserVersion`, `PlatformName`, `sauceUsername`, and `sauceAccessKey`).

`Host` enables us to specify whether our tests run locally or on Sauce Labs.

With `BrowserName`, `BrowserVeresion`, and `PlatformName` we can specify which browser and operating system combination we want our tests to run on. You can see a full list of Sauce's available platform options [here](https://saucelabs.com/platforms/). They also have a handy configuration generator (which will tell you what values to plug into your test) [here](https://docs.saucelabs.com/reference/platforms-configurator/). `sauceUsername` and `sauceAccessKey` enable us to connect and run our tests.

Now we can update our base test class to work with Selenium Remote. Let's start by pulling in the new configuration values.

```csharp
// filename: Tests/BaseTest.cs
// ...
    class BaseTest
    {
        private static string VendorDirectory = System.IO.Directory.GetParent(
            System.AppContext.BaseDirectory).
            Parent.Parent.Parent.FullName
            + @"/vendor";
        protected IWebDriver Driver;
        public static string BaseUrl;
        private static string Host;
        private static string BrowserName;
        private static string BrowserVersion;
        private static string PlatformName;

        [SetUp]
        protected void SetUp()
        {
            BaseUrl         = System.Environment.GetEnvironmentVariable("BASE_URL") ?? "http://the-internet.herokuapp.com";
            Host            = System.Environment.GetEnvironmentVariable("HOST") ?? "saucelabs";
            BrowserName     = System.Environment.GetEnvironmentVariable("BROWSER_NAME") ?? "ie";
            BrowserVersion  = System.Environment.GetEnvironmentVariable("BROWSER_VERSION") ?? "10.0";
            PlatformName    = System.Environment.GetEnvironmentVariable("PLATFORM_NAME") ?? "Windows 8";
            var sauceUsername = System.Environment.GetEnvironmentVariable("SAUCE_USERNAME");
            var sauceAccessKey = System.Environment.GetEnvironmentVariable("SAUCE_ACCESS_KEY");
            var url = new Uri($"http://{sauceUsername}:{sauceAccessKey}@ondemand.saucelabs.com:80/wd/hub");
// ...
```

Now to update our browser setup.

```csharp
// filename: Tests/BaseTest.cs
// ...
using OpenQA.Selenium.IE;
using OpenQA.Selenium.Edge;
using OpenQA.Selenium.Remote;
// ...
        [SetUp]
        protected void SetUp()
            // ...
            switch (Host.ToLower())
            {
                case "localhost":
                    switch (BrowserName.ToLower())
                    {
                        case "firefox":
                        {
                            var Service = FirefoxDriverService.CreateDefaultService(VendorDirectory);
                            Driver = new FirefoxDriver(Service);
                            break;
                        }
                        case "chrome":
                        {
                            var Service = ChromeDriverService.CreateDefaultService(VendorDirectory);
                            Driver = new ChromeDriver(Service);
                            break;
                        }
                    }
                    break;
                case "saucelabs":
                    switch (BrowserName.ToLower())
                    {
                        case "chrome":
                        {
                            ChromeOptions options = new ChromeOptions();
                            options.PlatformName = PlatformName;
                            options.BrowserVersion = BrowserVersion;
                            Driver = new RemoteWebDriver(url, options.ToCapabilities());
                            break;
                        }
                        case "edge":
                        {
                            EdgeOptions options = new EdgeOptions();
                            options.PlatformName = PlatformName;
                            options.BrowserVersion = BrowserVersion;
                            Driver = new RemoteWebDriver(url, options.ToCapabilities());
                            break;
                        }
                        case "firefox":
                        {
                            ChromeOptions options = new ChromeOptions();
                            options.PlatformName = PlatformName;
                            options.BrowserVersion = BrowserVersion;
                            Driver = new RemoteWebDriver(url, options.ToCapabilities());
                            break;
                        }
                        case "ie":
                        {
                            InternetExplorerOptions options = new InternetExplorerOptions();
                            options.PlatformName = PlatformName;
                            options.BrowserVersion = BrowserVersion;
                            Driver = new RemoteWebDriver(url, options.ToCapabilities());
                            break;
                        }
                    }
                    break;
            }
        }
// ...
```

In our `SetUp` method we've amended our conditional flow to check the `Host` variable first. We start by checking to see if it's set to `"localhost"` or `"saucelabs"`. If it's set to `"localhost"` we carry on just like before (checking the `BrowserName` value to determine which browser to launch locally).

If it's set to `"saucelabs"` we create an options object for the given browser, populate it with the `BrowserVersion` and `PlatformName` values and account URL (e.g., `"username"` and `"accessKey"` used in a basic auth URL). We then connect to Sauce Labs using Selenium Remote and pass in the options object. This will return a Selenium WebDriver instance that we can use just like when running our tests locally, except the browser is living on a machine in Sauce Labs' cloud.

If we save everything and run our tests they will execute in Sauce Labs and on the account dashboard we'll see our tests running in Internet Explorer 10 on Windows 8. And to run the tests on different combinations, you can specify them through environment variables on the command-line (e.g., `BROWSER_NAME="safari" BROWSER_VERSION="12.0" PLATFORM_NAME="macOS 10.14" dotnet test`).


### Part 2: Test Name

It's great that our tests are running on Sauce Labs. But we're not done yet because the test name in each Sauce job is getting set to `unnamed job`. This makes it extremely challenging to know what test was run in the job. To remedy this we'll need to pass in the test name in `DesiredCapabilities`.

```csharp
// filename: Tests/BaseTest.cs
// ...
        [TearDown]
        protected void TearDown()
        {
            if (Host.Equals("saucelabs"))
            {
                var testName = TestContext.CurrentContext.Test.Name;
                ((IJavaScriptExecutor)Driver).ExecuteScript("sauce:job-name=" + testName);
            }
            Driver.Quit();
        }
    }
}
```

Getting the test name from NUnit is a simple matter of calling `TestContext.CurrentContext.Test.Name`. This gives us the name of the test that is currently running, and we pass it to Sauce Labs through Selenium's `ExecuteScript` command. This runs JavaScript in the context of the application as it's running.

Now when we run our tests in Sauce Labs [the account dashboard](https://saucelabs.com/account) will show the tests running with a correct name.

### Part 3: Test Status

There's still one more thing we'll need to handle, and that's setting the status of the Sauce Labs job after it completes.

Right now regardless of the outcome of a test, the job in Sauce Labs will register as `Finished`. Ideally we want to know if the job was a `Pass` or a `Fail`. That way we can tell at a glance if a test failed or not. And with a couple of tweaks to the `TearDown` method in our base test we can make this happen easily enough.

```csharp
// filename: Tests/BaseTest.cs
// ...
        [TearDown]
        protected void TearDown()
        {
            if (Host.Equals("saucelabs"))
            {
                var testName = TestContext.CurrentContext.Test.Name;
                bool testPassed = TestContext.CurrentContext.Result.Outcome.Status.ToString() == "Passed";
                ((IJavaScriptExecutor)Driver).ExecuteScript("sauce:job-name=" + testName);
                ((IJavaScriptExecutor)Driver).ExecuteScript("sauce:job-result=" + (testPassed ? "passed" : "failed"));
                if(!testPassed)
                {
                    TestContext.WriteLine($"See a job at https://saucelabs.com/tests/{((RemoteWebDriver)Driver).SessionId}");
                }
            }
            Driver.Quit();
        }
    }
}
```

We first check to see if our tests are running against Sauce Labs. If so we check what the test result was and store the boolean result in a local variable. We then use Selenium's JavaScript Executor (just like with the test name) to pass the test result onto Sauce Labs. After that we output the URL for the Sauce Labs job to the console.

Now when we run our tests in Sauce Labs and navigate to [the Sauce Labs Account dashboard](https://saucelabs.com/account), we will see our tests running like before. But now there will be a proper test status when they finish (e.g., `Pass` or `Fail`) and we'll see the URL for the job in the console output as well. This enables us to easily jump to a specific job in Sauce Labs if we want to.

### Part 4: Sauce Connect

There are various ways that companies make their pre-production application available for testing. Some use an obscure public URL and protect it with some form of authentication (e.g., Basic Auth, or certificate based authentication). Others keep it behind their firewall. For those that stay behind a firewall, Sauce Labs has you covered.

They have a program called [Sauce Connect Proxy](https://wiki.saucelabs.com/display/DOCS/Setting+Up+Sauce+Connect+Proxy) that creates a secure tunnel between your machine and their private cloud. With it you can run tests in Sauce Labs and test applications that are only available on your private network.

To use Sauce Connect you need to download and run it. There's a copy for each operating system -- get yours [here](https://wiki.saucelabs.com/display/DOCS/Setting+Up+Sauce+Connect+Proxy) and run it from the command-line. In the context of our existing test code let's download Sauce Connect, unzip its contents, and store it in our `vendor` directory.

```text
├── PageObjects
│   ├── BasePage.cs
│   ├── DynamicLoadingPage.cs
│   └── LoginPage.cs
├── Tests
│   ├── BaseTest.cs
│   ├── DynamicLoadingTest.cs
│   └── LoginTest.cs
└── Vendor
    ├── chromedriver
    └── geckodriver
    └── sc
```

Now we just need to launch the application while specifying our Sauce account credentials.

```sh
vendor/sc -u $SAUCE_USERNAME -k $SAUCE_ACCESS_KEY
// ...
Starting Selenium listener...
Establishing secure TLS connection to tunnel...
Selenium listener started on port 4445.
Sauce Connect is up, you may start your tests.
```

Now that the tunnel is established, we could run our tests against a local instance of our application (e.g., [the-internet](https://github.com/tourdedave/the-internet)). Assuming the application was set up and running on our local machine, we run our tests against it by specifying a different base URL at runtime (e.g., `BASE_URL=http://localhost:4567 dotnet test`) and they would work.

To see the status of the tunnel, we can view it on [the tunnel page of the account dashboard](https://saucelabs.com/beta/tunnels). To shut the tunnel down, we can do it manually from this page. Or we can issue a `Ctrl+C` command to the terminal window where it's running.

When the tunnel is closing, here's what you'll see.

```sh
Got signal 2
Cleaning up.
Removing tunnel 21ff9664b06c4edaa4bd573cdc1fbac1.
All jobs using tunnel have finished.
Waiting for the connection to terminate...
Connection closed (8).
Goodbye.
```


