# A/B Testing

Sometimes when running tests you may hit unexpected behavior due to [A/B testing](http://en.wikipedia.org/wiki/A/B_testing) being done in the application you're working with.

In order to keep your tests running without issue we need a clean way to opt-out of these tests.

The standard opt-out behavior we have seen with A/B testing platforms (both commercial and custom) tends to be either an appended URL that you can pass in when navigating to a page (e.g., '?optimizely_opt_out=true') or forging a cookie (or some combination of the two).

## An Example

For this example we are going to demonstrate how to opt-out of a page that is controlled by Optimizely (a popular A/B Testing platform) by forging a cookie.

On our example page, the heading text will change based on which test group we are place in.

You can see the example application we are testing [here](http://the-internet.herokuapp.com/abtest).

```ruby
require 'selenium-webdriver'
require 'rspec-expectations'

def setup
  @driver = Selenium::WebDriver.for :firefox
end

def teardown
  @driver.quit
end

def run
  setup
  yield
  teardown
end
```

We start off the example by loading our libraries and preparing our setup, teardown, and run actions.

```ruby
run do
  @driver.get 'http://the-internet.herokuapp.com/abtest'
  heading_text = @driver.find_element(css: 'h3').text
  result = heading_text.include?('A/B Test Control') ||
    heading_text.include?('A/B Test Variation 1')
  result.should == true
  @driver.manage.add_cookie(name: 'optimizelyOptOut', value: 'true')
  @driver.navigate.refresh
  @driver.find_element(css: 'h3').text.should == 'No A/B Test'
end
```

In our run action we navigate to the page we want to test. We confirm that we are in one of the A/B test cells by grabbing the heading text and seeing if it includes the proper content.

After that we add the opt-out cookie, refresh the page, and then confirm that we are no longer in the A/B test cells (again, by confirming that the heading text has changed).

```ruby
run do
  @driver.get 'http://the-internet.herokuapp.com'
  @driver.manage.add_cookie(name: 'optimizelyOptOut', value: 'true')
  @driver.get 'http://the-internet.herokuapp.com/abtest'
  @driver.find_element(css: 'h3').text.should == 'No A/B Test'
end
```

Alternatively we can go to the main page of the site first, add the opt-out cookie, and then navigate to the page of interest & perform our checks.

## Expected Behavior

+ Load a page on the site
+ Add the opt-out cookie
+ Access the page of interest
+ Assert that the header text is correct
