# Organizing Your Test Runs

> "Am I the only Ruby dev who writes rake tasks for everything? Don't want to worry about the syntax of 50 different cmds or which dir I'm in." [[source]](https://twitter.com/russolsen/status/428227153377779713)  

> -- [Russ Olsen](http://russolsen.com/) (author of "Eloquent Ruby" and "Design Patterns in Ruby")

There's a lot to remember every time we want to run our tests now. So let's clean things up with some Rake tasks.

Rake is a library in Ruby that enables us to easily capture and run repetitive tasks. To set it up, we just need to install the 'rake' gem, add a 'Rakefile' in our root directory, and add our tasks to the 'Rakefile'. Then all we have to do is run our tasks using `rake` from the command-line.

Let's step through an example.

## An Example

### Part 1: Create A Rakefile And Add Initial Tasks

First we'll want to create a 'Rakefile' with some initial tasks.

```ruby
# filename: Rakefile

def launch_in_parallel(config_file)
  system("parallel_rspec #{'-n ' + ENV['processes'] if ENV['processes']} --test-options '-r ./#{config_file} --order random' spec")
end

desc 'Run tests locally, by browser'
task :local, :browser do |t, args|
  ENV['browser'] = args[:browser]
  launch_in_parallel('config/local.rb')
end

desc "Run tests in Sauce"
task :cloud do
  launch_in_parallel('config/cloud.rb')
end

desc "Run tests in Sauce Connect"
task :cloud_tunnel do
  ENV['tunnel'] = 'on'
  launch_in_parallel('config/cloud.rb')
end
```

Note that this looks similar to a standard Ruby file. We declare a method, reference that method, do some string interpolation, and set some environment variable values. It's the task declaration that's a little bit different (and specific to Rake).

To declare a task, we first want to give it a description. Descriptions are useful since they show up in our task list (next to the command to launch the task). If one is not set, then the task will not appear in the task list. To set one, we use the keyword `desc` and provide a string value (e.g., `'Run tests locally, by browser'`).

Once we have that, we can create the task itself. This is done with the keyword `task` followed by the name of the task (written as a symbol -- `:cloud`). The first line of a task ends with the word `do` -- this opens up the code block and terminates with the word `end`. Between `do` and `end` is where we place the code for our task.

Our `:local` task is a bit different than the others since we are taking an argument. To accomplish this we specify an additional parameter on the `task` line (e.g., `task :local, :browser`) and some variables in pipes after `do` (e.g., `do |t, args|`). With the `args` variable we are able to receive an argument at run time and pass it into the browser environment variable (e.g., `ENV['browser'] = args[:browser]`).

__NOTE: For more information on Rake, check out [this tutorial](http://jasonseifer.com/2010/04/06/rake-tutorial).__

In our `launch_in_parallel` method we pull out the lengthy command used to run our tests and wrap it in a `system` command to launch it. We also make this method accept an argument for the config file and inject it into the execution string through interpolation. This enables us to use it for each of our rake tasks. It also keeps our tasks clean -- removing redundancy -- and enables us to easily change our execution string (if we need to add additional arguments).

If we save this file, close it, and run `rake -T` from the command-line, we should see a list of our available Rake actions.

```sh
rake cloud           # Run tests in Sauce
rake cloud_tunnel    # Run tests in Sauce Connect
rake local[browser]  # Run tests locally, by browser
```

To run a task, just type `rake` followed by the task name. For tasks that take an argument, wrap the argument in single-quotes (e.g., `rake local['firefox']`). And to specify the number of parallel processes in our test runs, we do that with an environment variable before our `rake` command (e.g., `processes='5' rake cloud`).

If we run either the `cloud` or `local` tasks, they run our tests in parallel with 2 processes, in a random order, and should pass. But the `cloud_tunnel` task will result in failing tests since our local copy of 'the-internet' is probably not running. Let's remedy that by updating the `cloud_tunnel` task to start and stop it.

### Part 2: Automate Starting And Stopping Our Local Application

In our `:cloud_tunnel` task, we want to wrap our environment variable setting and test execution command with the necessary starting and stopping actions for our server. We already know how to start the server (`ruby server.rb` from within the 'vendor/the-internet' directory). But since there's no clean way to stop the server, we need to muck about with the process ID and send a kill command to it.

```ruby
# filename: Rakefile

...

desc "Run tests in Sauce Connect"
task :cloud_tunnel do
  Dir.chdir('vendor/the-internet')
  process_id = Process.spawn('ruby server.rb')
  Dir.chdir('../..')
    ENV['tunnel'] = 'on'
    launch_in_parallel('config/cloud.rb')
  Process.kill("KILL", process_id)
end
```

First, we change directories into `'vendor/the-internet'` to get access to the application and its dependent libraries. We then launch the server by spawning it in its own process (so it runs in the background); storing the return result (which is the process ID of the server, and a Fixnum value) in a variable.

We then traverse back up to the root directory, run our tests, and then stop the server when they're done -- issuing a kill command with the process ID that we stored.

Now if we run this task (`rake cloud_tunnel`) then our tests should run in Sauce Labs, through the secure tunnel, and exercise our locally served app.

### Part 3: Add Tasks For The Browsers We Care About

Now that we have Rake tasks we are in a better position to run tests quickly. But in order to make this approach worthwhile, we want to add more tasks to support different browser combinations. And while we're at it, we might as well make our local browser options explicit (rather than just argument based).

Let's start with the local tasks, and then add the cloud ones.

```ruby
# filename: Rakefile

def launch_in_parallel(config_file)
  system("parallel_rspec #{'-n ' + ENV['processes'] if ENV['processes']} --test-options '-r ./#{config_file} --order random' spec")
end

namespace :local do
  desc 'Run tests in Firefox'
  task :firefox do
    ENV['browser'] = 'firefox'
    launch_in_parallel('config/local.rb')
  end

  desc 'Run tests in Chrome'
  task :chrome do
    ENV['browser'] = 'chrome'
    launch_in_parallel('config/local.rb')
  end
end
...
```

Our `launch_in_parallel` method remains unchanged. We instead focus on reworking our local task -- turning it into two simple tasks which live underneath a namespace.

In Rake we can group common tasks together with a `namespace`, which follows the same naming conventions as a task. This helps organize our task list, making things more intuitive to run. You'll see what I mean soon.

Now let's add in our cloud tasks.

```ruby
# filename: Rakefile

...

namespace :cloud do
  desc "Run tests in IE, by version"
  task :ie, :version do |t, args|
    ENV['browser']  = 'internet_explorer'
    ENV['browser_version'] = args[:version]
    launch_in_parallel('config/cloud.rb')
  end

  desc "Run tests in Firefox, by version"
  task :firefox, :version do |t, args|
    ENV['browser']  = 'firefox'
    ENV['browser_version'] = args[:version]
    launch_in_parallel('config/cloud.rb')
  end

  desc "Run tests in Chrome, by version"
  task :chrome, :version do |t, args|
    ENV['browser']  = 'chrome'
    ENV['browser_version'] = args[:version]
    launch_in_parallel('config/cloud.rb')
  end

  desc "Run tests against local app in Sauce Connect"
  task :tunnel do
    Dir.chdir('vendor/the-internet')
    process_id = Process.spawn('ruby server.rb')
    Dir.chdir('../..')
      ENV['tunnel'] = 'on'
      launch_in_parallel('config/cloud.rb')
    Process.kill("KILL", process_id)
  end
end
```

By using a `:cloud` namespace we are able to group our cloud tasks together.

We've renamed our `:cloud_tunnel` task to `:tunnel` and removed our `:cloud` task -- replacing it with tasks for various browsers which take an argument for the browser version.

If we run `rake -T` we should see the following.

```sh
rake cloud:chrome[version]   # Run tests in Chrome, by version
rake cloud:firefox[version]  # Run tests in Firefox, by version
rake cloud:ie[version]       # Run tests in IE, by version
rake cloud:tunnel            # Run tests against local app in Sauce Connect
rake local:chrome            # Run tests in Chrome
rake local:firefox           # Run tests in Firefox
```

If we want to run our tests against Internet Explorer 8, all we have to do now is run `rake cloud:ie['8']`.

Keep in mind that our default operating system environment variable is set to 'Windows XP'. So if we try for a browser version that's too high (e.g., `rake cloud:ie['11']`), then we will receive an error message from Sauce Labs stating 'Unsupported OS/browser/version combo'.

To handle this, we need to alter the operating system environment variable (`ENV['operating_system']`) in our Rake tasks.

### Part 4: Update Tasks to Make The Operating System Configurable

We can pretty easily remedy this by adding an additional argument to our Rake tasks. Let's see what it would look like in our `:ie` task.

```ruby
# filename: Rakefile

namespace :cloud do

  desc "Run tests in IE, by OS and version"
  task :ie, :os, :version do |t, args|
    ENV['browser']  = 'internet_explorer'
    ENV['operating_system'] = args[:os]
    ENV['browser_version'] = args[:version]
    launch_in_parallel('config/cloud.rb')
  end

...
```

When we run `rake -T` we'll see our updated task list:

```sh
rake cloud:chrome[version]      # Run tests in Chrome, by version
rake cloud:firefox[version]     # Run tests in Firefox, by version
rake cloud:ie[os,version]       # Run tests in IE, by OS and version
rake cloud:tunnel               # Run tests against local app in Sauce Connect
rake local:chrome               # Run tests in Chrome
rake local:firefox              # Run tests in Firefox
```

Now if we wanted to run our tests against different versions of Internet Explorer, we can freely do it by specifying both the operating system and the version of IE. For example:

```sh
# note that there are no spaces around the comma (,)
rake cloud:ie['Windows XP','6']
rake cloud:ie['Windows XP','7']
rake cloud:ie['Windows XP','8']
rake cloud:ie['Windows 7','8']
rake cloud:ie['Windows 7','9']
rake cloud:ie['Windows 7','10']
rake cloud:ie['Windows 8','10']
```

Let's apply the same configuration to the Firefox and Chrome cloud tasks. And while we're at it, let's add the same (plus a browser argument) for the tunnel task.

```ruby
# filename: Rakefile

...

namespace :cloud do

  ...

  desc "Run tests in Firefox"
  task :firefox, :os, :version do |t, args|
    ENV['browser']  = 'firefox'
    ENV['operating_system'] = args[:os]
    ENV['browser_version'] = args[:version]
    launch_in_parallel('config/cloud.rb')
  end

  desc "Run tests in Chrome"
  task :chrome, :os, :version do |t, args|
    ENV['browser']  = 'chrome'
    ENV['operating_system'] = args[:os]
    ENV['browser_version'] = args[:version]
    launch_in_parallel('config/cloud.rb')
  end

  desc "Run tests against local app in Sauce Connect"
  task :tunnel, :os, :browser, :version do |t, args|
    ENV['browser']  = args[:browser]
    ENV['operating_system'] = args[:os]
    ENV['browser_version'] = args[:version]
    Dir.chdir('vendor/the-internet')
    process_id = Process.spawn('ruby server.rb')
    Dir.chdir('../..')
      ENV['tunnel'] = 'on'
      launch_in_parallel('config/cloud.rb')
    Process.kill("KILL", process_id)
  end
end
```

Now our task list should look like this.

```sh
rake cloud:chrome[os,version]          # Run tests in Chrome
rake cloud:firefox[os,version]         # Run tests in Firefox
rake cloud:ie[os,version]              # Run tests in IE
rake cloud:tunnel[os,browser,version]  # Run tests against local app in Sauce Connect
rake local:chrome                      # Run tests in Chrome
rake local:firefox                     # Run tests in Firefox
```

There are over 250 browser/OS combinations to choose from in Sauce Labs (you can see a full list [here](https://saucelabs.com/platforms)), and there are numerous ways to organize your Rake tasks. So if you aren't looking forward to the prospect of remembering and typing out the operating system, browser, or browser version for your test runs, simply create tasks for each of the browser/OS combinations you care about.

That's one of the biggest advantages to having a Rakefile -- you can be as explicit as you want, have a central list to see what is available, and can easily run each item on that list.
