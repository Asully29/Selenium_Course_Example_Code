# Forgot Password

Testing e-mail can be a tricky process. Especially when dealing with things like forgotten passwords. A lot of times, this functionality ends up being something that gets checked manually, or worse, overlooked until it ends up broken in production.

By leveraging a third-party library (like [gmail-ruby](https://github.com/dcparker/ruby-gmail)) we can access a test e-mail account (e.g., Gmail) outside of the browser to get the info we need and then put it to use with Selenium.

Let's dig in with an example that uses [the forgot password example](http://the-internet.herokuapp.com/forgot_password) on [the-internet](https://github.com/tourdedave/the-internet).

## An Example

First up we include our dependent libraries and create some setup, teardown, and run methods.

```ruby
# filename: forgot_password_gmail.rb

require 'selenium-webdriver'
require 'rspec-expectations'
include RSpec::Matchers
require 'gmail'

def setup
  @driver = Selenium::WebDriver.for :firefox
end

def teardown
  @driver.quit
end

def run
  setup
  yield
  teardown
end
```

The forgot password e-mail should be received pretty quickly, but since we're dealing with a third-party, we'll want to build in some resiliency. To do that, let's create a simple mechanism to retry a specified number of times -- sleeping some seconds in between each attempt.

```ruby
def try(number_of_times)
  count = 0 ; item_of_interest = false
  until item_of_interest == true || count == number_of_times
    item_of_interest = yield
    sleep 10
    count += 1
  end
end
```

Now that we have that, we can wire up our test.

```ruby
run do
  # Part 1: Initiate the forgot password email process
  @driver.get 'http://the-internet.herokuapp.com/forgot_password'
  @driver.find_element(id: 'email').send_keys(ENV['EMAIL_USERNAME'])
  @driver.find_element(id: 'form_submit').click

  # Part 2: Find the forgot password email from Gmail
  gmail = Gmail.new(ENV['EMAIL_USERNAME'], ENV['EMAIL_PASSWORD'])
  try(6) { @email = gmail.inbox.emails(:unread, from: 'no-reply@the-internet.herokuapp.com').last }
  message_body = @email.message.body.raw_source

  # Part 3: Parse the message body for the URL, username, and password
  url =  message_body.scan(/https?:\/\/[\S]+/).last
  username = message_body.scan(/username: (.*)$/)[0][0].strip
  password = message_body.scan(/password: (.*)$/)[0][0].strip

  # Part 4: Visit the login page, log in with the retrieved credentials, and assert that it worked
  @driver.get url
  @driver.find_element(id: 'username').send_keys username
  @driver.find_element(id: 'password').send_keys password
  @driver.find_element(id: 'login').submit
  @driver.current_url.include?('/secure').should be_true
end
```

When running this script you can pass in the Gmail account username and password at runtime (e.g., `EMAIL_USERNAME=youremail@gmail.com, EMAIL_PASSWORD=yourpassword ruby forgot_password_gmail.rb`)

If you have other things in an e-mail message you need to parse for and aren't sure of the regular expressions you need -- give [Rubular](http://rubular.com/) a try.
