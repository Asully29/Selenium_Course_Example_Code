# Packaging For Use

In order to get the most out of our tests and page objects, we'll need to package them into a more useful structure. Once that's done, we'll be able to add in the ability to run our tests against different browser and operating system combinations.

First we'll need to pull the test setup and teardown actions out of our tests and into a central place. In RSpec this is straight-forward through the use of a `spec_helper` file.

```ruby
# filename: spec_helper.rb

require 'selenium-webdriver'

RSpec.configure do |config|

  config.before(:each) do
    @driver = Selenium::WebDriver.for :firefox
  end

  config.after(:each) do
    @driver.quit
  end

end
```

We need to include the Selenium library here, and by doing so, can remove it from our tests. And by having our test configuration here, we can also clean up the  `before(:each)` and `after(:each)` in our tests by removing the `after(:each)` completely, but keeping the `before(:each)` around for setting up our page objects.

To use the `spec_helper` we'll need to require it in our tests. Here's an example of the login test after these changes have been made.

```ruby
require_relative 'spec_helper'
require_relative 'login'

describe 'Login' do

  before(:each) do
    @login = Login.new(@driver)
  end

  it 'succeeded' do
    @login.with('tomsmith', 'SuperSecretPassword!')
    @login.success_message_present?.should be_true
  end

  it 'failed' do
    @login.with('asdf', 'asdf')
    @login.failure_message_present?.should be_true
  end

end
```

## Folder Organization

Let's create some folders for our specs and page objects. To err on the side of simplicity, let's call the folders 'spec' (for our tests) and 'pages' (for our page objects). We are using 'spec' since it is a default folder that RSpec will look for.

Here's everything we should have after creating folders and moving files around:

```sh
.
|-- pages
|   |-- dynamic_loading.rb
|   `-- login.rb
`-- spec
    |-- dynamic_loading_spec.rb
    |-- login_spec.rb
    `-- spec_helper.rb
```

## Updating Require Statements

As a result of doing this, we will need to update the require statements in our tests.

```ruby
# filename: spec/login_spec.rb

require_relative 'spec_helper'
require_relative '../pages/login'

describe 'Login' do
...
```

```ruby
# filename: spec/dynamic_loading_spec.rb

require_relative 'spec_helper'
require_relative '../pages/dynamic_loading'

describe 'Dynamic Loading' do
...
```

Note the use of double-dots (`..`) in the page object require statement. This is how we tell Ruby to traverse up a directory (from our spec directory) before trying to access the page objects folder. The `spec_helper` require remains unchanged since this file lives in the same directory as our tests.

Now that things are cleaned up, we can run everything with the `rspec` command. Give it a shot. All of the tests should run and pass just like before.

Now we're ready to run our tests against different browser and operating system combinations.

## Running Tests On Any Browser

If you've ever needed to test features in an older browser like Internet Explorer 8 then odds are you ran a virtual machine (VM) on your computer with a "legit" version of Windows XP.

Handy, but what happens when you need to check things on multiple versions of IE? Now you're looking at multiple VMs. And what about when you need to scale and cover other browser and Operating System (OS) combinations? Now you're looking at provisioning, running, and maintaining your own farm of machines and standing up something like Selenium Grid to coordinate tests across them.

Rather than take on the overhead of a test infrastructure you can easily outsource things to a third-party cloud provider -- like Sauce Labs.

## An Example

### Step 1: Initial Setup

__NOTE: You'll need an account to use Sauce Labs. [Their free trial account](https://saucelabs.com/signup) has enough to get you started. And if you're signing up because you want to test an open source project, then be sure to give [their 'Open Sauce' account](https://saucelabs.com/opensauce) a look (tl;dr -- it's completely free).__

With Sauce Labs we need to provide specifics about what we want in our test environment, our credentials, and configure Selenium a little bit differently than we have been. Let's start by creating a config file for cloud execution.

```ruby
# filename: config_cloud.rb

ENV['host']             = 'saucelabs'
ENV['operating_system'] ||= 'Windows XP'
ENV['browser']          ||= 'internet_explorer'
ENV['browser_version']  ||= '8'
ENV['SAUCE_USERNAME']   ||= 'your-sauce-username'
ENV['SAUCE_ACCESS_KEY'] ||= 'your-sauce-access-key'
```

Notice the use of environment variables (most notably the host environment variable). This is what we'll use in our `spec_helper` file to determine whether to run things locally or in the cloud -- and we'll use the other environment variables to our Sauce Labs session.

For a full list of available browser and operating system combinations supported by Sauce Labs, go [here](https://saucelabs.com/platforms).

__NOTE: Be sure to update this file with you Sauce Username and Sauce Access Key, or, specify them externally (e.g., at run time, on the command-line, or in your bash profile). To get your Sauce Access Key, go to the bottom-left corner of your Sauce Account page.__

Now we'll need to update our `spec_helper` to connect to Sauce Labs and use these variables.

```ruby
# filename: spec/spec_helper.rb

require 'selenium-webdriver'

RSpec.configure do |config|

  config.before(:each) do
    case ENV['host']
    when 'saucelabs'
      caps = Selenium::WebDriver::Remote::Capabilities.send(ENV['browser'])
      caps.version = ENV['browser_version']
      caps.platform = ENV['operating_system']
      caps[:name] = example.metadata[:full_description]

      @driver = Selenium::WebDriver.for(
        :remote,
        url: "http://#{ENV['SAUCE_USERNAME']}:#{ENV['SAUCE_ACCESS_KEY']}\
              @ondemand.saucelabs.com:80/wd/hub",
        desired_capabilities: caps)
    else
      @driver = Selenium::WebDriver.for :firefox
    end
  end

  config.after(:each) do
    @driver.quit
  end

end
```

Notice that we've added a conditional to check on the host environment variable. If the host is set to 'saucelabs', then we configure our tests to point at Sauce Labs (passing in the requisite information that we will need for the session). Otherwise, it will run our tests locally using Firefox.

Now if we run our test suite along with our cloud configuration file (`rspec -r ./config_cloud.rb`) and navigate to [our Sauce Labs Account page](https://saucelabs.com/account) then we will see each of the tests running in their own job, with proper names, against Internet Explorer 8.

And to run the tests on an alternate browser (or operating system), you can either update the values in the config_cloud file, or, you can specify them at runtime like so:

```sh
browser='chrome' browser_version='31' rspec -r ./config_cloud.rb
```
