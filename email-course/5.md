# Packaging For Use

In order to get the most out of our tests and page objects, we'll need to package them into a more useful structure. Once that's done, we'll be able to add in the ability to run our tests against different browser and operating system combinations.

First we'll need to pull the test setup and teardown actions out of our tests and into a central place. In RSpec this is straight-forward through the use of a `spec_helper.rb` file.

```ruby
# filename: spec/spec_helper.rb
require 'selenium-webdriver'

RSpec.configure do |config|

  config.before(:each) do
    @driver = Selenium::WebDriver.for :firefox
  end

  config.after(:each) do
    @driver.quit
  end

end
```

We require the Selenium library here since we're working directly with it. By having it here we can remove it from our tests. We can also remove our Selenium commands from the `before(:each)` and `after(:each)` in our tests -- replacing them with a simple require statement at the top of the test file (`require_relative 'spec_helper'`). We will also be able to remove the `after(:each)` method from our tests, leaving just the `before(:each)` for use with our page objects.

Here's what our tests look like with these changes made.

```ruby
# filename: spec/login_spec.rb
require_relative 'spec_helper'
require_relative '../pages/login'

describe 'Login' do

  before(:each) do
    @login = Login.new(@driver)
  end

  it 'succeeded' do
    @login.with('tomsmith', 'SuperSecretPassword!')
    expect(@login.success_message_present?).to eql true
  end

  it 'failed' do
    @login.with('asdf', 'asdf')
    expect(@login.failure_message_present?).to eql true
  end

end
```

```ruby
# filename: spec/dynamic_loading_spec.rb
require_relative 'spec_helper'
require_relative '../pages/dynamic_loading'

describe 'Dynamic Loading' do

  before(:each) do
    @dynamic_loading = DynamicLoading.new(@driver)
  end

  it 'Example 1: Hidden Element' do
    @dynamic_loading.example 1
    @dynamic_loading.start
    expect(@dynamic_loading.finish_text_present?).to eql true
  end

  it 'Example 2: Rendered after the fact' do
    @dynamic_loading.example 2
    @dynamic_loading.start
    expect(@dynamic_loading.finish_text_present?).to eql true
  end

end
```

## Running Tests On Any Browser

If you've ever needed to test features in an older browser like Internet Explorer 8 then odds are you ran a virtual machine (VM) on your computer with a "legit" version of Windows XP.

Handy, but what happens when you need to check things on multiple versions of IE? Now you're looking at multiple VMs. And what about when you need to scale and cover other browser and Operating System (OS) combinations? Now you're looking at provisioning, running, and maintaining your own farm of machines and standing up something like Selenium Grid to coordinate tests across them.

And all you wanted to do was run your tests on the browsers you cared about...

Rather than take on the overhead of a test infrastructure you can easily outsource things to a third-party cloud provider. There are a handful of players in this space, but there's one that stands out -- Sauce Labs.

## An Example

__NOTE: You'll need an account to use Sauce Labs. Their free trial offers more than enough to get you started ([link](https://saucelabs.com/signup/trial?utm_medium=email&utm_campaign=bootcamp&utm_source=elemental-selenium)) (no credit-card required).__

With Sauce Labs we need to provide our credentials, specifics about what we want in our test environment, and configure Selenium a little bit differently than we have been. Let's start by creating a new config file for cloud execution.

```ruby
# filename: config_cloud.rb

ENV['base_url']         ||= 'http://the-internet.herokuapp.com'
ENV['host']             = 'saucelabs'
ENV['operating_system'] ||= 'Windows XP'
ENV['browser']          ||= 'internet_explorer'
ENV['browser_version']  ||= '8'
# ENV['SAUCE_USERNAME']   = 'your-sauce-username'
# ENV['SAUCE_ACCESS_KEY'] = 'your-sauce-access-key'
```

Notice the use of a host environment variable (e.g., `ENV['host'] = 'saucelabs'`). This is what we'll use in our `spec_helper` file to determine whether to run things locally or in the cloud. We can specify our Sauce Labs credentials here by hard-coding them, or we configure them on our system. And we'll use the `operating_system`, `browser`, and `browser_version` environment variables to populate the `Capabilities` object (the configuration object used to specify the browser, operating system, and browser we want to use in Sauce Labs).

```ruby
# filename: spec/spec_helper.rb
require 'selenium-webdriver'

RSpec.configure do |config|

  config.before(:each) do |example|
    case ENV['host']
    when 'saucelabs'
      caps = Selenium::WebDriver::Remote::Capabilities.send(ENV['browser'])
      caps.version = ENV['browser_version']
      caps.platform = ENV['operating_system']
      caps[:name] = example.metadata[:full_description]

      @driver = Selenium::WebDriver.for(
        :remote,
        url: "http://#{ENV['SAUCE_USERNAME']}:#{ENV['SAUCE_ACCESS_KEY']}@ondemand.saucelabs.com:80/wd/hub",
        desired_capabilities: caps)
    else
      @driver = Selenium::WebDriver.for :firefox
    end
  end

  config.after(:each) do
    @driver.quit
  end

end
```

We've taken our central Selenium setup and added a conditional check against the host environment variable. If the host is set to `'saucelabs'`, then we configure the capabilities for Selenium Remote and pass in the requisite information that we will need for our Sauce Labs session. Otherwise, our tests will run locally on Firefox.

There are a few things in this example that may be worth elaborating on.

First, we are using something called metaprogramming (a.k.a. code that writes code) when we are calling `Selenium::WebDriver::Remote::Capabilities`. We are using the `.send` method to pass in the browser environment variable. Which, in this case, is the same name as the method to configure Selenium Remote to use Internet Explorer. So we are in effect specifying `Selenium::WebDriver::Remote::Capabilitites.internet_explorer`. And if we were to specify 'chrome' for `ENV['browser']`, then it would give us `Selenium::WebDriver::Remote::Capabilities.chrome`.

Second, for `caps[:name]` we are using a piece of functionality built into RSpec which gives us the name of each test as it is being run. This will make it so each individual job in Sauce Labs will have the correct name of the test that was run.

Third, for the `url:` line in our `@driver` instantiation, we are injecting our environment variable through the use of string interpolation. This is why we are using double-quoted strings. If they were single-quotes then we wouldn't be able to do it.

Now if we run our test suite (`rspec -r ./config_cloud.rb`) and navigate to [our Sauce Labs Account page](https://saucelabs.com/account) then we will see each of the tests running in their own job, with proper names, against Internet Explorer 8.

And to run the tests on an alternate browser (or operating system), you can either update the values in the config_cloud file, or, you can specify them at runtime like so:

```ruby
browser='chrome' browser_version='31' rspec -r ./config_cloud.rb
```
